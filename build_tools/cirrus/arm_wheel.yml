macos_arm64_test_task:
  macos_instance:
    image: ghcr.io/cirruslabs/macos-ventura-base:latest
  env:
    CONFTEST_PATH: ${CIRRUS_WORKING_DIR}/conftest.py
    CONFTEST_NAME: conftest.py
    CIBW_ENVIRONMENT: OMP_NUM_THREADS=2
                      OPENBLAS_NUM_THREADS=2
                      SKLEARN_SKIP_NETWORK_TESTS=1
                      SKLEARN_BUILD_PARALLEL=5
                      CPU_COUNT=2
    CIBW_TEST_COMMAND: bash {project}/build_tools/github/test_wheels.sh
    CIBW_TEST_REQUIRES: pytest pandas threadpoolctl pytest-xdist
    CIBW_BUILD_VERBOSITY: 1
    PATH: $HOME/mambaforge/bin/:$PATH
    CONDA_HOME: $HOME/mambaforge
  matrix:
    - env:
        CIBW_BUILD: cp38-macosx_arm64
        CIBW_TEST_SKIP: "*"
    - env:
        CIBW_BUILD: cp39-macosx_arm64
        CIBW_TEST_SKIP: "*"
    - env:
        CIBW_BUILD: cp310-macosx_arm64
        CIBW_TEST_SKIP: "*"
    - env:
        # Only test on the latest python version
        CIBW_BUILD: cp311-macosx_arm64

  conda_script:
    - curl -L -o ~/mambaforge.sh https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-arm64.sh
    - bash ~/mambaforge.sh -b -p $HOME/mambaforge

  test_script:
    - bash build_tools/github/build_wheels.sh
